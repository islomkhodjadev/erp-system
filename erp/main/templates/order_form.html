<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Форма заказа Плинтуса</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .order-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .order-form label {
            display: block;
            margin: 10px 0 5px;
        }

        .order-form input,
        .order-form select {
            width: 120px;
            padding: 10px;
            margin: 5px 0 15px;
            border-radius: 5px;
            text-align: center;
            box-sizing: border-box;
            font-size: 18px;
            border: 1px solid #ccc;
        }

        .order-form input:focus,
        .order-form select:focus {
            outline: none;
        }

        input.valid {
            border-color: green;
        }

        input.invalid {
            border-color: red;
        }

        button {
            padding: 10px 20px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            width: 100%;
            box-sizing: border-box;
        }

        button:hover {
            background-color: #218838;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Popup styling */
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 80%;
            max-width: 400px;
        }

        .popup select {
            padding: 10px;
            margin: 10px 0;
            width: 100%;
        }

        .popup button {
            margin-top: 10px;
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .order-form {
                padding: 15px;
            }
            button {
                width: 100%;
            }
            .popup-content {
                width: 90%;
            }
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

</head>
<body>
    <h2>Форма заказа Плинтуса</h2>

    <!-- Order Form -->
    <form method="POST" class="order-form">
        {% csrf_token %}
        {{ form }}
        <div id="codePopup" class="popup">
            <div class="popup-content">
                <h3>Выберите код плинтуса:</h3>
                <select id="codeSelect" onchange="updateCode()">
                    {% for plintus in plintus_list %}
                    <option value="{{ plintus.code }}" data-price="{{ plintus.price }}" data-stock="{{ plintus.count_in_packs }}">
                        {{ plintus.code }} 
                    </option>
                    {% endfor %}
                </select>
                <button type="button" onclick="closeCodePopup()">Закрыть</button>
            </div>
        </div>
        <p>Итоговая стоимость: <span id="totalPrice">{{ total_price }}</span> $</p>

        <input type="submit" value="Submit">
        <button type="reset">Очистить</button>
    </form>

<script>

if (window.Telegram && window.Telegram.WebApp) {
        // Access the initDataUnsafe property
        const initDataUnsafe = window.Telegram.WebApp.initDataUnsafe;
        const user = initDataUnsafe.user;
        const userId = user ? user.id : "";

        if (userId) {
            // Set the user_id hidden input value
            document.getElementById('user_id').value = userId;
        } else {
            console.error('User ID not available');
        }
    } else {
        console.error('Telegram Web App is not initialized');
    }
    const status = "{{ status }}";  // This will get the value from Django context
        if (status === 'true') {
            // If status is true (order is successful), close the Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.close();
            }
        }
        
     // Global variable to store the selected Plintus and its components
let selectedPlintus = null;
let components = [];

function openCodePopup() {
    document.getElementById('codePopup').style.display = 'flex';
}

function closeCodePopup() {
    document.getElementById('codePopup').style.display = 'none';
    const select = document.getElementById('codeSelect');
    const selectedOption = select.options[select.selectedIndex];
    document.getElementById('plintusCode').value = selectedOption.value;  // Update input to only show code
    fetchPlintusComponents(selectedOption);  // Fetch components and update price when code is selected
}

function updateCode() {
    const select = document.getElementById('codeSelect');
    const selectedOption = select.options[select.selectedIndex];
    document.getElementById('plintusCode').value = selectedOption.value;  // Update input to only show code
    fetchPlintusComponents(selectedOption);  // Fetch components and update price when code is selected
}

function fetchPlintusComponents(plintusCode) {
    console.log(plintusCode);
    const apiUrl = `/get_plintus_component/${plintusCode.value}/`; // Replace with your actual API endpoint

    fetch(apiUrl)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json(); // Parse the JSON response
      })
      .then((data) => {
        console.log("Plintus Components:", data);

        // Store the selected Plintus and its components globally
        selectedPlintus = data.plintus;
        components = data.components;

        // Display components and initialize input fields
        components.forEach((component) => {
            document.getElementById(component.code).value = 0;  // Reset input value
            console.log(
                `Type: ${component.type}, Code: ${component.code}, Price: ${component.price}, Packs: ${component.count_in_packs}`
            );
        });

        // Recalculate the total price
        calculateTotal();
      })
      .catch((error) => {
        console.error(`Fetch error: ${error.message}`);
      });
}


function validateInput(input, componentType) {
    
    const component = components.find((comp) => comp.type === componentType);
    let maxCount = component ? component.count_in_packs : 0;

    // If it's the plintus quantity field, we need to handle it differently
    if (componentType === 'plintus') {
        maxCount = selectedPlintus ? selectedPlintus.count_in_packs : 0;
    }

    const inputValue = parseInt(input.value, 10);

    // Check if the input value exceeds the available packs
    if (inputValue > maxCount) {
        input.classList.remove("valid");
        input.classList.add("invalid");
    } else {
        input.classList.remove("invalid");
        input.classList.add("valid");
    }
}

function calculateTotal() {
    let totalPrice = 0;

    // Get the quantity of Plintus (numberOfPlintus)
    const plintusQuantity = parseInt(document.getElementById("numberOfPlintus").value, 10) || 0;  // Default to 0 if invalid
    
    // Check if the selected plintus exists and its price is available
    if (selectedPlintus && selectedPlintus.price) {
        // Add the price of the selected plintus multiplied by the quantity
        totalPrice += selectedPlintus.price * plintusQuantity;
    }

    // Loop over the components and add their price multiplied by the input value
    components.forEach((component) => {
        const componentQuantity = parseInt(document.getElementById(component.type).value, 10) || 0;  // Default to 0 if invalid
        if (component.price) { // Check if the component has a price
            totalPrice += component.price * componentQuantity;
        }
    });

    // Update total price in the UI
    document.getElementById("totalPrice").textContent = totalPrice.toFixed(2);
}



    </script>
</body>
</html>
