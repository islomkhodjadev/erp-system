<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{order_plintus_form}}</title>
    <style>
        body {
    font-family: Arial, sans-serif;
    background-color: var(--tg-theme-bg-color, #f4f4f9);
    color: var(--tg-theme-text-color, #000000);
    margin: 0;
    padding: 20px;
    /* Add these properties */
    position: fixed;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .order-form {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .order-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
            position: relative;
        }

        .order-row:last-child {
            border-bottom: none;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

        .form-group label {
            color: var(--tg-theme-hint-color, #666666);
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 120px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            background-color: var(--tg-theme-bg-color, #f4f4f9);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            outline: none;
        }

        .remove-row {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .valid {
            border-color: green !important;
        }

        .invalid {
            border-color: red !important;
        }

        .row-total {
            font-weight: bold;
            min-width: 100px;
        }

        .actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .add-row {
            background-color: var(--tg-theme-button-color, #28a745);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
        }

        .submit-form {
            background-color: var(--tg-theme-button-color, #0088cc);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
        }

        .total-price {
            text-align: right;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 2px solid var(--tg-theme-hint-color, #cccccc);
        }

        @media (max-width: 768px) {
            .order-row {
                flex-direction: column;
                align-items: stretch;
                padding-bottom: 40px;
            }

            .form-group {
                width: 100%;
            }

            .form-group input,
            .form-group select {
                width: 100%;
            }

            .remove-row {
                bottom: 10px;
                top: auto;
                right: 10px;
                transform: none;
            }
        }
    </style>
     <script src="https://telegram.org/js/telegram-web-app.js"></script>

</head>
<body>
    <h2>{{order_plintus_form}}</h2>

    <form method="POST" class="order-form" id="plintusOrderForm">
        {% csrf_token %}
        <input type="hidden" id="user_id" name="user_id" value="">
        <div id="orderRows"></div>
        
        <div class="total-price">
            {{total_price}}: <span id="grandTotal">0.0</span> $
        </div>
        
        <div class="actions">
            <button type="button" class="add-row">+ Add Order</button>
            <button type="submit" class="submit-form">{{submit}}</button>
        </div>
    </form>

    <script>

        
        document.addEventListener('DOMContentLoaded', function() {
            let orderRowCounter = 0;
            const plintusData = JSON.parse('{{ plintus_list | escapejs }}');

            function createOrderRow() {
                const rowId = `row-${orderRowCounter++}`;
                const row = document.createElement('div');
                row.className = 'order-row';
                row.id = rowId;

                row.innerHTML = `
                    <div class="form-group">
                        <label>{{ plintus_code }}</label>
                        <select name="plintus_code[]" onchange="handleSelectChange(event, '${rowId}')" required>
                            <option value="">{{ choose_plintus }}</option>
                            ${plintusData.map(p => `
                                <option value="${p.code}" 
                                    data-price="${p.price}" 
                                    data-stock="${p.count_in_packs}">
                                    ${p.code}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>{{ number_of_plintus }}</label>
                        <input type="number" name="number_of_plintus[]" 
                            min="0" value="0" 
                            oninput="handleInputChange(event, '${rowId}')">
                    </div>
                    <div class="form-group">
                        <label>{{ vnutrenniy_ugol }}</label>
                        <input type="number" name="vnutrenniy_ugol[]" 
                            min="0" value="0" 
                            oninput="handleInputChange(event, '${rowId}')">
                    </div>
                    <div class="form-group">
                        <label>{{ naruzhniy_ugol }}</label>
                        <input type="number" name="naruzhniy_ugol[]" 
                            min="0" value="0" 
                            oninput="handleInputChange(event, '${rowId}')">
                    </div>
                    <div class="form-group">
                        <label>{{ zaglushka_levaya }}</label>
                        <input type="number" name="zaglushka_levaya[]" 
                            min="0" value="0" 
                            oninput="handleInputChange(event, '${rowId}')">
                    </div>
                    <div class="form-group">
                        <label>{{ zaglushka_pravaya }}</label>
                        <input type="number" name="zaglushka_pravaya[]" 
                            min="0" value="0" 
                            oninput="handleInputChange(event, '${rowId}')">
                    </div>
                    <div class="form-group">
                        <label>{{ soedinitel }}</label>
                        <input type="number" name="soedinitel[]" 
                            min="0" value="0" 
                            oninput="handleInputChange(event, '${rowId}')">
                    </div>
                    <div class="row-total">
                        Total: <span>0.0</span> $
                    </div>
                    <button type="button" class="remove-row" onclick="removeRow('${rowId}')">Ã—</button>
                `;
                return row;
            }

            function addOrderRow() {
                const orderRows = document.getElementById('orderRows');
                orderRows.appendChild(createOrderRow());
            }

            document.querySelector('.add-row').addEventListener('click', addOrderRow);

            addOrderRow();

            const initDataUnsafe = window.Telegram.WebApp.initDataUnsafe;
            const user = initDataUnsafe.user;

            if (user && user.id) {
                document.getElementById('user_id').value = user.id;
            } else {
                // If there's no user or user ID, close the Telegram Web App
                alert('User ID not found. The application will now close.');
                window.Telegram.WebApp.close();
            }

        });

        async function handleSelectChange(event, rowId) {
            const plintusCode = event.target.value;
            try {
                const response = await fetch(`/erp/get_plintus_component/${plintusCode}/`);
                const data = await response.json();
                
                const row = document.getElementById(rowId);
                
                row.dataset.components = JSON.stringify(data.components);
                row.dataset.plintus = JSON.stringify(data.plintus);
                console.log(row);
                validateRowInputs(rowId);
                calculateRowTotal(rowId);
            } catch (error) {
                console.error('Error fetching components:', error);
            }
        }

        function handleInputChange(event, rowId) {
            validateRowInputs(rowId);
            calculateRowTotal(rowId);
        }

        function removeRow(rowId) {
            document.getElementById(rowId).remove();
            calculateGrandTotal();
        }

        function validateRowInputs(rowId) {
            const row = document.getElementById(rowId);
            const components = JSON.parse(row.dataset.components || '[]');
            console.log(components);
            const plintus = JSON.parse(row.dataset.plintus || '{}');
            
            const plintusInput = row.querySelector('input[name="number_of_plintus[]"]');
            validateInput(plintusInput, plintus.count_in_packs);
            
            components.forEach(component => {
                const input = row.querySelector(`input[name="${component.type}[]"]`);
                validateInput(input, component.count_in_packs);
            });
        }

        function validateInput(input, maxCount) {
            if (!input || maxCount === undefined) return;
            
            const value = parseInt(input.value) || 0;
            if (value > maxCount) {
                input.classList.remove('valid');
                input.classList.add('invalid');
            } else {
                input.classList.remove('invalid');
                input.classList.add('valid');
            }
        }

        function calculateRowTotal(rowId) {
            const row = document.getElementById(rowId);
            const components = JSON.parse(row.dataset.components || '[]');
            const plintus = JSON.parse(row.dataset.plintus || '{}');
            
            let total = 0;
            
            const plintusQty = parseInt(row.querySelector('input[name="number_of_plintus[]"]').value) || 0;
            total += plintusQty * (plintus.price || 0);
            
            components.forEach(component => {
                const qty = parseInt(row.querySelector(`input[name="${component.type}[]"]`).value) || 0;
                total += qty * component.price;
            });
            
            row.querySelector('.row-total span').textContent = total.toFixed(2);
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            const rows = document.querySelectorAll('.order-row');
            let grandTotal = 0;
            
            rows.forEach(row => {
                const rowTotal = parseFloat(row.querySelector('.row-total span').textContent);
                grandTotal += rowTotal;
            });
            
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        }

        document.getElementById('plintusOrderForm').onsubmit = function(e) {
    e.preventDefault();
    
    const invalidInputs = document.querySelectorAll('.invalid');
    if (invalidInputs.length > 0) {
        alert('Please correct the quantities marked in red');
        return false;
    }

    // Create an array to hold all rows' data
    const orderData = [];

    // Collect data for each row
    document.querySelectorAll('.order-row').forEach(row => {
        const plintusCode = row.querySelector('select[name="plintus_code[]"]').value;
        const numberOfPlintus = row.querySelector('input[name="number_of_plintus[]"]').value;
        const vnutrenniyUgol = row.querySelector('input[name="vnutrenniy_ugol[]"]').value;
        const naruzhniyUgol = row.querySelector('input[name="naruzhniy_ugol[]"]').value;
        const zaglushkaLevaya = row.querySelector('input[name="zaglushka_levaya[]"]').value;
        const zaglushkaPravaya = row.querySelector('input[name="zaglushka_pravaya[]"]').value;
        const soedinitel = row.querySelector('input[name="soedinitel[]"]').value;

        // Push row data as an object to the array
        orderData.push({
            plintus_code: plintusCode,
            number_of_plintus: numberOfPlintus,
            vnutrenniy_ugol: vnutrenniyUgol,
            naruzhniy_ugol: naruzhniyUgol,
            zaglushka_levaya: zaglushkaLevaya,
            zaglushka_pravaya: zaglushkaPravaya,
            soedinitel: soedinitel
        });
    });
    console.log(orderData);
            fetch('/erp/order/ru/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify({
                user_id: document.getElementById('user_id').value,
                order_data: orderData
            })
        })
        .then(response => {
            if (!response.ok) {
                // If the response is not OK (status code is not 2xx), parse and throw the error
                return response.json().then(err => {
                    const errorMessages = parseErrorMessages(err.errors || err);
                    throw new Error(errorMessages);
                });
            }
            return response.json(); // Parse the successful JSON response
        })
        .then(data => {
            // Handle successful response
            console.log('Order placed successfully:', data);
            alert('Order submitted successfully!');

            // Close the Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.close();
            } else {
                console.error('Telegram WebApp API not available.');
            }
        })
        .catch(error => {
            // Handle network errors or HTTP errors
            console.error('Error submitting order:', error.message);
            alert(`An error occurred: ${error.message}`);
        });

        /**
         * Parse error messages from the server response into a user-friendly string.
         * @param {Object} errors - The error object from the server response.
         * @returns {string} - A formatted string with error details.
         */
        function parseErrorMessages(errors) {
            if (typeof errors !== 'object' || errors === null) return 'An unknown error occurred.';

            const errorMessages = [];
            for (const [field, messages] of Object.entries(errors)) {
                if (Array.isArray(messages)) {
                    messages.forEach(msg => {
                        errorMessages.push(`${field}: ${msg}`);
                    });
                } else {
                    errorMessages.push(`${field}: ${messages}`);
                }
            }
            return errorMessages.join('\n');
        }
        

};

    </script>

</body>
</html>
